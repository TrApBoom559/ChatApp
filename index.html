<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Ultra Secure E2E Chat ‚Äî Mobile friendly</title>

<!-- Firebase (compat used –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<style>
  :root{
    --accent:#2563eb; --muted:#64748b; --bg:#f6f8fb; --card:#ffffff; --ok:#16a34a; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, Roboto, Arial, sans-serif;background:var(--bg);color:#0f172a;-webkit-font-smoothing:antialiased}
  .app{max-width:980px;margin:0 auto;height:100vh;display:flex;flex-direction:column}
  header{background:linear-gradient(90deg,var(--accent),#1d4ed8);color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  header .brand{font-weight:700;font-size:17px}
  header .controls{display:flex;align-items:center;gap:8px}
  header .controls button{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.08);color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer}
  main{flex:1;display:flex;padding:12px;gap:12px;align-items:stretch;min-height:0}

  /* single column for mobile */
  .panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(16,24,40,.06);flex:1;display:flex;flex-direction:column;min-width:0}
  .entry{width:100%}
  .row{display:flex;gap:8px;margin-bottom:8px}
  input[type="text"], input[type="password"], input, textarea{flex:1;padding:12px;border-radius:10px;border:1px solid #e6eefc;font-size:15px;background:#fbfdff}
  .btn{padding:10px 12px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
  .btn.ghost{background:#fff;border:1px solid #e6eefc;color:var(--accent)}
  .status-ok{color:var(--ok);font-size:13px}
  .status-err{color:var(--danger);font-size:13px}
  hr{border:none;border-top:1px solid #eef2f7;margin:12px 0}

  /* chat layout */
  .chat-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
  .badge{background:#eef4ff;color:#1e40af;padding:6px 8px;border-radius:8px;font-size:13px}
  .room-meta{display:flex;flex-direction:column;gap:6px}
  .room-id{font-weight:700;font-size:17px;word-break:break-all}
  .owner-line{font-size:13px;color:var(--muted)}
  .fp-compact{font-family:monospace;font-size:12px;background:#fbfdff;padding:8px;border-radius:8px;border:1px dashed #e6eefc;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .participants{background:#fff;border-radius:10px;padding:8px;border:1px solid #eef4ff;flex:0 0 auto;margin-top:8px}
  .participant{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:8px}
  .messages-area{flex:1;overflow:auto;padding:12px;border-radius:10px;border:1px solid #eef4ff;background:linear-gradient(180deg,#fff,#fbfdff);min-height:220px}
  .msg-row{max-width:84%;display:block;margin-bottom:10px}
  .msg-row.mine{margin-left:auto;text-align:right}
  .msg-meta{font-size:12px;color:#344054;margin-bottom:6px}
  .msg{padding:12px;border-radius:12px;background:#f1f5f9;border:1px solid #e6eefc;display:inline-block;word-break:break-word}
  .mine .msg{background:#dcfce7}
  .composer{display:flex;gap:8px;padding-top:10px;align-items:center}
  .composer input{flex:1;padding:12px;border-radius:999px;border:1px solid #e6eefc;background:#fff}
  .small{font-size:13px;color:var(--muted);}

  /* mobile tweaks */
  @media (max-width:600px){
    main{flex-direction:column;padding:10px}
    header{padding:10px}
    .room-id{font-size:16px}
    .btn{padding:10px; font-size:15px}
    .messages-area{min-height:260px}
  }

  /* controls for code block */
  .code-block{background:#fbfdff;padding:10px;border-radius:8px;border:1px dashed #e6eefc;font-family:monospace;overflow:auto}
  .flex-row{display:flex;gap:8px;align-items:center}
  .muted-btn{background:#fff;border:1px solid #eef4ff;color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">Ultra Secure E2E Chat</div>
    <div class="controls">
      <div id="header-nick" class="small"></div>
      <button id="profile-btn">–ü—Ä–æ—Ñ–∏–ª—å</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <!-- ENTRY -->
      <div id="entry" class="entry">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>

        <label>–ù–∏–∫ (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)</label>
        <div class="row"><input id="nick-input" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: TrApBoom"></div>

        <label>–ü–∞—Ä–æ–ª—å</label>
        <div class="row"><input id="pwd-input" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6)"></div>

        <div id="nick-status"></div>

        <div class="row">
          <button id="register-btn" class="btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
          <button id="login-btn" class="btn ghost">–í–æ–π—Ç–∏</button>
        </div>

        <hr>

        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px;">
          <div class="flex-row">
            <button id="create-btn" class="btn">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            <div class="small" style="margin-left:6px;">–°–æ–∑–¥–∞—ë—Ç –∫–æ—Ä–æ—Ç–∫–∏–π ID –∏ –∫–ª—é—á (E2E)</div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;">
            <input id="join-input" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã (–∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–¥) –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á" style="padding:10px;border-radius:8px;border:1px solid #e6eefc;flex:1;background:#fff">
            <button id="join-btn" class="btn ghost">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
          </div>
        </div>

        <div class="small">–°–æ–≤–µ—Ç: –∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ—Ä–æ—Ç–∫–∏–π ID –∫–æ–º–Ω–∞—Ç—ã (–æ–Ω –∫–æ—Ä–æ—á–µ –∏ —É–¥–æ–±–Ω–µ–µ), –¥–ª–∏–Ω–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.</div>
      </div>

      <!-- PROFILE -->
      <div id="profile" class="profile" style="display:none">
        <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
        <p>–í–∞—à –Ω–∏–∫: <b id="profile-nick">‚Äî</b></p>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <button id="logout-btn" class="btn ghost">–í—ã–π—Ç–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
          <button id="delete-btn" class="btn" style="background:var(--danger);color:#fff">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>

        <hr/>
        <h3>–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
        <div class="row"><input id="newpwd1" type="password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"></div>
        <div class="row"><input id="newpwd2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"></div>
        <button id="changepwd-btn" class="btn ghost">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
        <div id="pwd-status" class="small"></div>

        <hr/>
        <div style="display:flex;gap:8px;">
          <button id="back-btn" class="btn">–ù–∞–∑–∞–¥</button>
        </div>
      </div>

      <!-- CHAT -->
      <div id="chat-panel" style="display:none;flex-direction:column;height:100%;gap:10px;">
        <div class="chat-top" style="align-items:center;">
          <div class="room-meta">
            <div class="small">ID –∫–æ–º–Ω–∞—Ç—ã (–∫–æ—Ä–æ—Ç–∫–∏–π)</div>
            <div id="session-id" class="room-id">‚Äî</div>
            <div class="owner-line">–í–ª–∞–¥–µ–ª–µ—Ü: <span id="owner-nick">‚Äî</span></div>
          </div>

          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
            <div class="badge">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <span id="participants-count">0</span></div>

            <div style="width:220px;">
              <div style="font-weight:700;margin-bottom:6px">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</div>
              <div class="code-block">
                <div id="code-short" style="font-weight:600;font-size:15px;word-break:break-all">‚Äî</div>
                <div id="pub-key-wrapper" style="margin-top:8px;display:none;">
                  <div class="small" style="margin-bottom:4px">–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á (–¥–ª–∏–Ω–Ω—ã–π, E2E)</div>
                  <div id="public-key" class="code-block" style="max-height:110px;overflow:auto;font-family:monospace;white-space:normal"></div>
                </div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                  <button id="copy-id" class="muted-btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button>
                  <button id="toggle-key" class="muted-btn">–ü–æ–∫–∞–∑–∞—Ç—å –∫–ª—é—á</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:12px;flex-direction:column;margin-top:8px;">
          <div class="messages-area" id="messages-area"></div>

          <form id="msg-form" class="composer">
            <input id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
            <button id="send-btn" class="btn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </form>

          <div class="participants">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <div style="font-weight:700">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
              <div class="small" id="participants-count-top">0</div>
            </div>
            <div id="participants-list" style="display:flex;flex-direction:column;gap:4px;max-height:160px;overflow:auto"></div>
          </div>
        </div>
      </div>

    </section>
  </main>
</div>

<script>
/* ====== CONFIG (—Ç–≤–æ–π Firebase, –æ—Å—Ç–∞–≤–ª–µ–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDHL6xRYLKGIJnjlMgIbX8XlNVfSOI2cIY",
  authDomain: "chat-5ac4f.firebaseapp.com",
  projectId: "chat-5ac4f",
  storageBucket: "chat-5ac4f.firebasestorage.app",
  messagingSenderId: "68050436057",
  appId: "1:68050436057:web:71ffddbe76b0765291a3c8",
  measurementId: "G-XFCT24V2MS"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* ====== DOM refs ====== */
const entry = document.getElementById('entry');
const profile = document.getElementById('profile');
const chatPanel = document.getElementById('chat-panel');

const nickInput = document.getElementById('nick-input');
const pwdInput = document.getElementById('pwd-input');
const nickStatus = document.getElementById('nick-status');

const registerBtn = document.getElementById('register-btn');
const loginBtn = document.getElementById('login-btn');

const createBtn = document.getElementById('create-btn');
const joinInput = document.getElementById('join-input');
const joinBtn = document.getElementById('join-btn');

const profileBtn = document.getElementById('profile-btn');
const profileNick = document.getElementById('profile-nick');
const headerNick = document.getElementById('header-nick');

const logoutBtn = document.getElementById('logout-btn');
const deleteBtn = document.getElementById('delete-btn');
const changepwdBtn = document.getElementById('changepwd-btn');
const newpwd1 = document.getElementById('newpwd1');
const newpwd2 = document.getElementById('newpwd2');
const pwdStatus = document.getElementById('pwd-status');
const backBtn = document.getElementById('back-btn');

const sessionIdEl = document.getElementById('session-id');
const ownerNickEl = document.getElementById('owner-nick');

const codeShort = document.getElementById('code-short');
const publicKeyEl = document.getElementById('public-key');
const pubKeyWrapper = document.getElementById('pub-key-wrapper');
const toggleKeyBtn = document.getElementById('toggle-key');
const copyIdBtn = document.getElementById('copy-id');

const participantsCountEl = document.getElementById('participants-count');
const participantsCountTop = document.getElementById('participants-count-top');
const participantsList = document.getElementById('participants-list');

const messagesArea = document.getElementById('messages-area');
const msgForm = document.getElementById('msg-form');
const msgInput = document.getElementById('msg-input');
const sendBtn = document.getElementById('send-btn');

let me = null;
let myNick = null;
let myNickId = null;
let ecdh = null;
let session = null;          // short session id (doc id)
let roomKey = null;         // AES key for messages
let partRef = null;
let ownerPub = null;
let displayed = new Set();
let showPubKey = false;

/* ====== Crypto helpers (original ones preserved) ====== */
function ab2b64(ab){ return btoa(String.fromCharCode(...new Uint8Array(ab))); }
function b642ab(b){ const bin = atob(b); const a = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) a[i]=bin.charCodeAt(i); return a.buffer; }

async function genECDH(){ return crypto.subtle.generateKey({name:'ECDH',namedCurve:'P-256'}, true, ['deriveBits']); }
async function expPub(k){ return ab2b64(await crypto.subtle.exportKey('raw', k)); }
async function impPub(b64){ return crypto.subtle.importKey('raw', b642ab(b64), {name:'ECDH',namedCurve:'P-256'}, true, []); }
async function der(priv, pub){ const bits = await crypto.subtle.deriveBits({name:'ECDH', public: pub}, priv, 256); return crypto.subtle.importKey('raw', bits, {name:'AES-GCM'}, false, ['encrypt','decrypt']); }

async function genAES(){ return crypto.subtle.generateKey({name:'AES-GCM', length:256}, true, ['encrypt','decrypt']); }
async function expRaw(k){ return await crypto.subtle.exportKey('raw', k); }
async function impRaw(buf){ return crypto.subtle.importKey('raw', buf, {name:'AES-GCM'}, false, ['encrypt','decrypt']); }

async function enc(k, t){ const iv = crypto.getRandomValues(new Uint8Array(12)); const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, k, new TextEncoder().encode(t)); return {iv: ab2b64(iv), ct: ab2b64(ct)}; }
async function dec(k, ivB64, ctB64){ const iv = new Uint8Array(b642ab(ivB64)); const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, k, b642ab(ctB64)); return new TextDecoder().decode(pt); }

async function derivePasswordBits(password, saltUint8Array, iterations=150000){
  const enc = new TextEncoder();
  const key = await crypto.subtle.importKey('raw', enc.encode(password), {name:'PBKDF2'}, false, ['deriveBits']);
  return crypto.subtle.deriveBits({name:'PBKDF2', salt: saltUint8Array, iterations, hash: 'SHA-256'}, key, 256);
}

/* UI helpers */
function showEntry(){ entry.style.display='block'; profile.style.display='none'; chatPanel.style.display='none'; headerNick.textContent=''; }
function showProfile(){ entry.style.display='none'; profile.style.display='block'; chatPanel.style.display='none'; profileNick.textContent = myNick || '‚Äî'; headerNick.textContent = myNick ? `üë§ ${myNick}` : ''; }
function showChat(){ entry.style.display='none'; profile.style.display='none'; chatPanel.style.display='flex'; headerNick.textContent = myNick ? `üë§ ${myNick}` : ''; msgInput.disabled = false; sendBtn.disabled = false; }
function setStatus(msg, ok=true){ nickStatus.innerHTML = ok ? `<span class="status-ok">${msg}</span>` : `<span class="status-err">${msg}</span>`; }

/* ====== Auth & init ====== */
auth.signInAnonymously().then(async r=>{
  me = r.user;
  ecdh = await genECDH();
  attachHandlers();

  // try restore nick by uid
  try {
    const q = await db.collection('nicknames').where('uid','==', me.uid).limit(1).get();
    if(!q.empty){
      const doc = q.docs[0];
      myNickId = doc.id;
      myNick = doc.data().display || myNickId;
      headerNick.textContent = `üë§ ${myNick}`;
      setStatus('–í—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞ ‚Äî –≤—ã –≤–æ—à–ª–∏', true);
    } else {
      showEntry();
    }
  } catch(e){
    console.error('restore fail', e);
    showEntry();
  }
}).catch(e=>{ console.error('auth error', e); alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏'); });

/* ====== Handlers setup ====== */
function attachHandlers(){
  // nick live check
  let tmr = null;
  nickInput.addEventListener('input', ()=>{
    clearTimeout(tmr);
    const n = nickInput.value.trim();
    if(!n || /\s/.test(n)){ nickStatus.textContent=''; return; }
    const id = n.toLowerCase();
    tmr = setTimeout(async ()=>{
      try{
        const snap = await db.collection('nicknames').doc(id).get();
        if(snap.exists) setStatus('–ù–∏–∫ –∑–∞–Ω—è—Ç ‚Äî –Ω–∞–∂–º–∏—Ç–µ –í–æ–π—Ç–∏', false); else setStatus('–ù–∏–∫ —Å–≤–æ–±–æ–¥–µ–Ω', true);
      }catch(e){ nickStatus.textContent=''; }
    }, 250);
  });

  // Register
  registerBtn.addEventListener('click', async ()=>{
    if(!me) return alert('–ü–æ–¥–æ–∂–¥–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
    const n = nickInput.value.trim(); const pwd = pwdInput.value || '';
    if(!n || /\s/.test(n)) return setStatus('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–∏–∫', false);
    if(pwd.length < 6) return setStatus('–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', false);
    const id = n.toLowerCase();
    const ref = db.collection('nicknames').doc(id);
    try{
      await db.runTransaction(async tx=>{
        const s = await tx.get(ref);
        if(s.exists) throw new Error('occupied');
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const bits = await derivePasswordBits(pwd, salt);
        tx.set(ref, {
          uid: me.uid,
          display: n,
          salt: ab2b64(salt.buffer),
          pwdHash: ab2b64(bits),
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
      myNick = n; myNickId = id;
      setStatus('–ù–∏–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω ‚úî', true);
      headerNick.textContent = `üë§ ${myNick}`;
    }catch(e){
      setStatus('–ù–∏–∫ –∑–∞–Ω—è—Ç ‚Äî –Ω–∞–∂–º–∏—Ç–µ –í–æ–π—Ç–∏', false);
    }
  });

  // Login
  loginBtn.addEventListener('click', async ()=>{
    if(!me) return alert('–ü–æ–¥–æ–∂–¥–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
    const n = nickInput.value.trim(); const pwd = pwdInput.value || '';
    if(!n || /\s/.test(n)) return setStatus('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–∏–∫', false);
    if(!pwd) return setStatus('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', false);
    const id = n.toLowerCase();
    const ref = db.collection('nicknames').doc(id);
    try{
      const snap = await ref.get();
      if(!snap.exists) return setStatus('–ù–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å', false);
      const d = snap.data();
      if(!d.salt || !d.pwdHash) return setStatus('–ù–∏–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ', false);
      const saltBuf = b642ab(d.salt);
      const bits = await derivePasswordBits(pwd, new Uint8Array(saltBuf));
      const hashB64 = ab2b64(bits);
      if(hashB64 !== d.pwdHash) return setStatus('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', false);
      myNick = d.display || n; myNickId = id;
      setStatus('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω ‚úî', true);
      headerNick.textContent = `üë§ ${myNick}`;
      try { await ref.update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }); } catch(e){}
    }catch(e){
      console.error(e);
      setStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ', false);
    }
  });

  // Profile nav
  profileBtn.addEventListener('click', ()=>{
    if(!myNick) return alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å/–≤–æ–π–¥–∏—Ç–µ');
    showProfile();
  });
  backBtn.addEventListener('click', ()=>{ if(session) showChat(); else showEntry(); });

  // Logout / Delete / Change password
  logoutBtn.addEventListener('click', async ()=>{ myNick = null; myNickId = null; headerNick.textContent = ''; setStatus('–í—ã –≤—ã—à–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ.', true); showEntry(); });
  deleteBtn.addEventListener('click', async ()=>{
    if(!myNickId) return alert('–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –Ω–∏–∫–∞');
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
    try{
      const ref = db.collection('nicknames').doc(myNickId);
      const snap = await ref.get();
      if(snap.exists && snap.data().uid === me.uid){ await ref.delete(); } else { alert('–í—ã –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü —ç—Ç–æ–≥–æ –Ω–∏–∫–∞ (—É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ)'); }
    }catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); }
    myNick = null; myNickId = null; headerNick.textContent = '';
    showEntry();
  });
  changepwdBtn.addEventListener('click', async ()=>{
    const p1 = newpwd1.value || '', p2 = newpwd2.value || '';
    if(p1.length < 6) return pwdStatus.textContent = '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
    if(p1 !== p2) return pwdStatus.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
    if(!myNickId) return pwdStatus.textContent = '–ù–µ—Ç –Ω–∏–∫–∞';
    try{
      const ref = db.collection('nicknames').doc(myNickId);
      const snap = await ref.get();
      if(!snap.exists) return pwdStatus.textContent = '–î–æ–∫—É–º–µ–Ω—Ç –Ω–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω';
      const data = snap.data();
      if(data.uid !== me.uid) return pwdStatus.textContent = '–í—ã –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü –Ω–∏–∫–∞ ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –Ω–µ–ª—å–∑—è';
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const bits = await derivePasswordBits(p1, salt);
      await ref.update({ salt: ab2b64(salt.buffer), pwdHash: ab2b64(bits) });
      pwdStatus.textContent = '–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω ‚úî';
      newpwd1.value = ''; newpwd2.value = '';
    }catch(e){
      console.error(e);
      pwdStatus.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è';
    }
  });

  /* ---------- Chat / session buttons (—É–ª—É—á—à–µ–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ) ---------- */

  // Create room ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π ID –∏ –ø—É–±–ª–∏–∫—É–µ–º ownerPublicKey –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
  createBtn.addEventListener('click', async ()=>{
    if(!myNick) return alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å/–≤–æ–π–¥–∏—Ç–µ');
    try{
      // –∫–æ—Ä–æ—Ç–∫–∏–π —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π id
      session = Math.random().toString(36).slice(2,10);
      sessionIdEl.textContent = session;
      ownerNickEl.textContent = myNick;
      ownerPub = await expPub(ecdh.publicKey);
      roomKey = await genAES();
      await db.collection('sessions').doc(session).set({
        ownerUid: me.uid,
        ownerNick: myNick,
        ownerPublicKey: ownerPub,
        ts: firebase.firestore.FieldValue.serverTimestamp()
      });
      // –¥–æ–±–∞–≤–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞-–≤–ª–∞–¥–µ–ª—å—Ü–∞
      partRef = db.collection('sessions').doc(session).collection('participants').doc(me.uid);
      await partRef.set({ uid: me.uid, nickname: myNick, publicKey: ownerPub, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });

      // UI
      codeShort.textContent = session;
      publicKeyEl.textContent = ownerPub;
      pubKeyWrapper.style.display = 'none';
      toggleKeyBtn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –∫–ª—é—á';
      showChat();

      listenPartsOwner();
      listenMsgs();
      listenRequestsOwner();

      // copy handlers
      copyIdBtn.onclick = ()=>{ navigator.clipboard.writeText(session); copyIdBtn.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úî'; setTimeout(()=>copyIdBtn.textContent='–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID',1200); };
      toggleKeyBtn.onclick = ()=>{ showPubKey = !showPubKey; pubKeyWrapper.style.display = showPubKey ? 'block' : 'none'; toggleKeyBtn.textContent = showPubKey ? '–°–∫—Ä—ã—Ç—å –∫–ª—é—á' : '–ü–æ–∫–∞–∑–∞—Ç—å –∫–ª—é—á'; };
      alert('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞. –ö–æ—Ä–æ—Ç–∫–∏–π ID: ' + session + '\n–ï–≥–æ —É–¥–æ–±–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.');
    }catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã'); }
  });

  // Join: –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –≤–≤–æ–¥ –ª–∏–±–æ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ ID, –ª–∏–±–æ –¥–ª–∏–Ω–Ω–æ–≥–æ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ (–ø–æ–∏—Å–∫)
  joinBtn.addEventListener('click', async ()=>{
    if(!myNick) return alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å/–≤–æ–π–¥–∏—Ç–µ');
    const raw = joinInput.value.trim(); if(!raw) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –≤–ª–∞–¥–µ–ª—å—Ü–∞');
    try{
      let sid = raw;
      // –µ—Å–ª–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á (–¥–ª–∏–Ω–Ω—ã–π base64-like), –ø–æ–∏—â–µ–º —Å–µ—Å—Å–∏–∏ –ø–æ ownerPublicKey
      const maybePub = raw.length > 40;
      if(maybePub){
        const q = await db.collection('sessions').where('ownerPublicKey','==', raw).limit(1).get();
        if(!q.empty){
          sid = q.docs[0].id;
        } else {
          // try if user pasted public key with trailing spaces/newlines -> trim and search
          const trimmed = raw.replace(/\s+/g, '');
          const q2 = await db.collection('sessions').where('ownerPublicKey','==', trimmed).limit(1).get();
          if(!q2.empty) sid = q2.docs[0].id;
        }
      }

      const doc = await db.collection('sessions').doc(sid).get();
      if(!doc.exists) return alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ ID –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –≤–ª–∞–¥–µ–ª—å—Ü–∞)');
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É (owner –ø–æ–ª—É—á–∏—Ç –∑–∞–ø—Ä–æ—Å –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–¥–∞—Å—Ç –∫–ª—é—á, –µ—Å–ª–∏ –æ–¥–æ–±—Ä–∏—Ç)
      await db.collection('sessions').doc(sid).collection('requests').doc(me.uid).set({
        uid: me.uid,
        nickname: myNick,
        publicKey: await expPub(ecdh.publicKey),
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'pending'
      });
      alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤–ª–∞–¥–µ–ª—å—Ü—É –∫–æ–º–Ω–∞—Ç—ã. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
      session = sid;
      sessionIdEl.textContent = session;
      ownerNickEl.textContent = doc.data().ownerNick || '‚Äî';
      ownerPub = doc.data().ownerPublicKey || null;
      codeShort.textContent = session;
      publicKeyEl.textContent = ownerPub || '‚Äî';
      pubKeyWrapper.style.display = ownerPub ? 'none' : 'none';
      toggleKeyBtn.textContent = ownerPub ? '–ü–æ–∫–∞–∑–∞—Ç—å –∫–ª—é—á' : '‚Äî';

      // —Å–ª—É—à–∞–µ–º participant doc –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç encryptedRoomKey (owner —Ä–∞–∑–¥–∞—ë—Ç –µ–≥–æ)
      partRef = db.collection('sessions').doc(session).collection('participants').doc(me.uid);
      partRef.onSnapshot(async snap=>{
        if(snap.exists){
          const d = snap.data();
          if(d.encryptedRoomKey && !roomKey){
            try{
              // d.encryptedRoomKey stored as ivB64:ctB64
              const [ivB64, ctB64] = d.encryptedRoomKey.split(':');
              const op = await impPub(ownerPub);
              const derKey = await der(ecdh.privateKey, op);
              const raw = await crypto.subtle.decrypt({name:'AES-GCM', iv: new Uint8Array(b642ab(ivB64))}, derKey, b642ab(ctB64));
              roomKey = await impRaw(raw);
              listenMsgs();
              showChat();
              msgInput.disabled = false; sendBtn.disabled = false;
              alert('–í—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã ‚Äî –∫–ª—é—á –ø–æ–ª—É—á–µ–Ω.');
            }catch(e){ console.error('decrypt roomKey fail', e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∫–ª—é—á –∫–æ–º–Ω–∞—Ç—ã'); }
          }
        }
      });

    }catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'); }
  });

  // Listen for join requests (owner UI placeholder ‚Äî –º–æ–∂–Ω–æ —Ä–∞–∑–≤–∏—Ç—å)
  function listenRequestsOwner(){
    const reqCol = db.collection('sessions').doc(session).collection('requests');
    reqCol.onSnapshot(snapshot=>{
      // —Å–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –ª–æ–≥, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –≤–æ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
      snapshot.docChanges().forEach(ch=>{
        if(ch.type === 'added'){
          // –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ participants (–≤ –ø—Ä–æ–¥–∞–∫—à–Ω–µ: —Å–ø—Ä–æ—Å–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞)
          // –ó–¥–µ—Å—å: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ participants (owner) –∏ —Ä–∞–∑–¥–∞—ë–º –∫–ª—é—á.
          // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤ —ç—Ç–æ–π –¥–µ–º–æ ‚Äî –±—É–¥–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å –∏ —Ä–∞–∑–¥–∞–≤–∞—Ç—å.
          (async ()=>{
            const rq = ch.doc.data();
            // –¥–æ–±–∞–≤–ª—è–µ–º –≤ participants –µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç
            const pRef = db.collection('sessions').doc(session).collection('participants').doc(rq.uid);
            const pSnap = await pRef.get();
            if(!pSnap.exists){
              await pRef.set({ uid: rq.uid, nickname: rq.nickname, publicKey: rq.publicKey, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
            }
            // –ø–æ–º–µ—Ç–∏–º –∑–∞–ø—Ä–æ—Å –∫–∞–∫ accepted (—á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å)
            await ch.doc.ref.update({ status: 'accepted' });
          })();
        }
      });
    });
  }

  // Owner: distribute roomKey to participants (–ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏)
  function listenPartsOwner(){
    const col = db.collection('sessions').doc(session).collection('participants');
    col.onSnapshot(async snap=>{
      participantsCountEl.textContent = snap.size;
      participantsCountTop.textContent = snap.size;
      participantsList.innerHTML = '';
      for(const doc of snap.docs){
        const d = doc.data();
        const row = document.createElement('div');
        row.className = 'participant';
        row.innerHTML = `<div style="font-weight:600">${d.nickname||'‚Äî'}</div><div class="small">${d.uid===me.uid ? '–Ø' : ''}</div>`;
        participantsList.appendChild(row);
      }
      for(const ch of snap.docChanges()){
        if(ch.type === 'added'){
          const d = ch.doc.data();
          // –µ—Å–ª–∏ —è –≤–ª–∞–¥–µ–ª–µ—Ü –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–º–µ–µ—Ç encryptedRoomKey ‚Äî –∑–∞—à–∏—Ñ—Ä—É–µ–º –∏ –æ–±–Ω–æ–≤–∏–º
          if(d.publicKey && !d.encryptedRoomKey && me && d.uid !== undefined){
            try{
              const s = await db.collection('sessions').doc(session).get();
              if(s.exists && s.data().ownerUid === me.uid){
                const remotePub = await impPub(d.publicKey);
                const k = await der(ecdh.privateKey, remotePub);
                const raw = await expRaw(roomKey);
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, k, raw);
                await ch.doc.ref.update({ encryptedRoomKey: ab2b64(iv) + ':' + ab2b64(ct) });
              }
            }catch(e){ console.error('distribute key failed', e); }
          }
        }
      }
    });
  }

  // Messages listener (decrypt using roomKey)
  function listenMsgs(){
    messagesArea.innerHTML = '';
    db.collection('sessions').doc(session).collection('messages').orderBy('ts').onSnapshot(snap=>{
      snap.docChanges().forEach(async ch=>{
        if(ch.type === 'added'){
          if(displayed.has(ch.doc.id)) return;
          displayed.add(ch.doc.id);
          const d = ch.doc.data();
          if(!roomKey) return;
          try{
            const t = await dec(roomKey, d.iv, d.ct);
            addMsg(d.senderUid === me.uid ? myNick : (d.senderNick || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'), t, d.senderUid === me.uid);
          }catch(e){ console.error('decrypt msg fail', e); }
        }
      });
    });
  }

  // Send message
  msgForm.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const text = msgInput.value.trim(); if(!text || !roomKey) return;
    try{
      const {iv, ct} = await enc(roomKey, text);
      await db.collection('sessions').doc(session).collection('messages').add({
        senderUid: me.uid, senderNick: myNick, iv, ct, ts: firebase.firestore.FieldValue.serverTimestamp()
      });
      msgInput.value = '';
    }catch(e){ console.error(e); }
  });

  function addMsg(nick, text, mine){
    const r = document.createElement('div'); r.className = 'msg-row' + (mine ? ' mine' : '');
    const m = document.createElement('div'); m.className = 'msg-meta'; m.textContent = nick;
    const b = document.createElement('div'); b.className = 'msg'; b.textContent = text;
    r.appendChild(m); r.appendChild(b); messagesArea.appendChild(r); messagesArea.scrollTop = messagesArea.scrollHeight;
  }

  // copy & toggle buttons (default noop until set)
  copyIdBtn.addEventListener('click', ()=>{ if(session) { navigator.clipboard.writeText(session); copyIdBtn.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úî'; setTimeout(()=>copyIdBtn.textContent='–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID',1200); } });
  toggleKeyBtn.addEventListener('click', ()=>{ showPubKey = !showPubKey; pubKeyWrapper.style.display = showPubKey ? 'block' : 'none'; toggleKeyBtn.textContent = showPubKey ? '–°–∫—Ä—ã—Ç—å –∫–ª—é—á' : '–ü–æ–∫–∞–∑–∞—Ç—å –∫–ª—é—á'; });

} // end attachHandlers

</script>
</body>
</html>
