<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ultra-Secure E2E Chat</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<style>
  :root{--accent:#2563eb;--ok:#16a34a;--danger:#ef4444}
  *{box-sizing:border-box}
  body{font-family:Inter,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#f3f6fb,#fff);padding:18px;color:#0f172a}
  .wrap{max-width:920px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(16,24,40,.08);overflow:hidden}
  header{background:var(--accent);color:#fff;padding:18px 22px}
  header h1{margin:0;font-size:20px}
  main{display:grid;grid-template-columns:360px 1fr;gap:18px;padding:18px}
  .panel{background:#fbfdff;border-radius:10px;padding:12px;border:1px solid #eef2ff}
  .section{margin-bottom:12px}
  label{display:block;font-size:13px;margin-bottom:6px;color:#0f172a}
  input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eefc;background:#fff}
  button{background:var(--accent);color:#fff;padding:10px 12px;border-radius:8px;border:none;cursor:pointer}
  button.ghost{background:#fff;color:var(--accent);border:1px solid #dbeafe}
  .small{font-size:13px;color:#475569;margin-top:8px}
  .hint{font-size:12px;color:#64748b}
  .ok{color:var(--ok)} .err{color:var(--danger)}
  .chat{display:flex;flex-direction:column;height:64vh}
  .chat-header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid #f1f5f9}
  .session-id{font-weight:600;color:var(--accent);word-break:break-all}
  .fingerprint{font-size:12px;background:#fff8e1;padding:8px;border-radius:8px;color:#6b4226;margin-top:8px;word-break:break-all}
  .messages{flex:1;overflow:auto;padding:12px;background:linear-gradient(180deg,#fbfdff,#f8fafc);border-radius:8px;margin:12px 0;border:1px solid #eef2ff}
  .msg{max-width:70%;padding:10px;border-radius:12px;margin-bottom:8px;word-break:break-word}
  .mine{background:#dcfce7;margin-left:auto;text-align:right}
  .their{background:#fff;border:1px solid #e6eefc}
  .sys{background:#eef2ff;color:#0b61d5;text-align:center}
  .composer{display:flex;gap:10px}
  .composer input{flex:1;padding:10px;border-radius:999px;border:1px solid #e6eefc}
  .controls{display:flex;gap:10px;align-items:center}
  .panic{background:var(--danger)}
  footer{padding:12px;text-align:center;font-size:12px;color:#64748b}
  @media (max-width:880px){main{grid-template-columns:1fr;}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Ultra-Secure E2E Chat</h1>
      <div style="font-size:12px;opacity:.9">Полное E2E: ECDH (P-256) → AES-GCM-256</div>
    </header>

    <main>
      <!-- LEFT PANEL -->
      <div class="panel">
        <div class="section">
          <label>Ваш ник (уникальный)</label>
          <input id="nick-input" type="text" placeholder="Введите ник (без пробелов)" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="claim-nick-btn">Занять ник</button>
            <button id="release-nick-btn" class="ghost" style="display:none">Освободить ник</button>
          </div>
          <div id="nick-status" class="small hint"></div>
        </div>

        <div class="section">
          <label>Создать комнату</label>
          <div style="display:flex;gap:8px">
            <button id="create-session-btn">Создать</button>
            <button id="copy-session-btn" class="ghost" style="display:none">Копировать ID</button>
          </div>
        </div>

        <div class="section">
          <label>Присоединиться к комнате</label>
          <input id="join-id" type="text" placeholder="ID комнаты" />
          <button id="join-btn" style="margin-top:8px">Присоединиться</button>
        </div>

        <div class="section">
          <label>Инструменты</label>
          <div style="display:flex;gap:8px">
            <button id="leave-btn" class="ghost">Покинуть</button>
            <button id="panic-btn" class="panic" style="margin-left:auto">PANIC</button>
          </div>
        </div>
      </div>

      <!-- RIGHT CHAT -->
      <div class="panel chat">
        <div class="chat-header">
          <div>
            <div style="font-size:14px">Комната: <span class="session-id" id="session-id">—</span></div>
            <div id="owner-info" style="font-size:12px;color:#475569">Владелец: —</div>
            <div id="fp" class="fingerprint" style="display:none"></div>
          </div>
          <div class="controls"><div id="participants-count" class="small">Участников: 0</div></div>
        </div>

        <div id="messages" class="messages"></div>
        <form id="msg-form" class="composer">
          <input id="msg-input" placeholder="Введите сообщение..." disabled autocomplete="off" />
          <button id="send-btn" disabled>Отправить</button>
        </form>
      </div>
    </main>

    <footer>Сообщения зашифрованы локально (AES-GCM 256). Panic удаляет все сообщения.</footer>
  </div>

<script>
/* Firebase init */
const firebaseConfig = {
  apiKey: "AIzaSyDHL6xRYLKGIJnjlMgIbX8XlNVfSOI2cIY",
  authDomain: "chat-5ac4f.firebaseapp.com",
  projectId: "chat-5ac4f",
  storageBucket: "chat-5ac4f.firebasestorage.app",
  messagingSenderId: "68050436057",
  appId: "1:68050436057:web:71ffddbe76b0765291a3c8",
  measurementId: "G-XFCT24V2MS"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* DOM */
const nickInput=document.getElementById('nick-input');
const claimNickBtn=document.getElementById('claim-nick-btn');
const releaseNickBtn=document.getElementById('release-nick-btn');
const nickStatus=document.getElementById('nick-status');
const createSessionBtn=document.getElementById('create-session-btn');
const copySessionBtn=document.getElementById('copy-session-btn');
const joinInput=document.getElementById('join-id');
const joinBtn=document.getElementById('join-btn');
const sessionIdEl=document.getElementById('session-id');
const ownerInfo=document.getElementById('owner-info');
const fpDiv=document.getElementById('fp');
const participantsCount=document.getElementById('participants-count');
const messagesDiv=document.getElementById('messages');
const msgForm=document.getElementById('msg-form');
const msgInput=document.getElementById('msg-input');
const sendBtn=document.getElementById('send-btn');
const leaveBtn=document.getElementById('leave-btn');
const panicBtn=document.getElementById('panic-btn');

/* State */
let me=null,myNick=null,myNickId=null,currentSession=null,isOwner=false;
let ecdhKeyPair=null,ownerPublicB64=null,roomKey=null;
let participantDocRef=null,unsubMessages=null,unsubParticipants=null;

/* Utils */
function abToB64(ab){return btoa(String.fromCharCode(...new Uint8Array(ab)));}
function b64ToAb(b64){const bin=atob(b64);const arr=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)arr[i]=bin.charCodeAt(i);return arr.buffer;}
async function generateECDH(){return crypto.subtle.generateKey({name:'ECDH',namedCurve:'P-256'},true,['deriveBits']);}
async function exportPublic(key){const raw=await crypto.subtle.exportKey('raw',key);return abToB64(raw);}
async function importPublic(b64){return crypto.subtle.importKey('raw',b64ToAb(b64),{name:'ECDH',namedCurve:'P-256'},true,[]);}
async function deriveSymKey(priv,pub){const bits=await crypto.subtle.deriveBits({name:'ECDH',public:pub},priv,256);return crypto.subtle.importKey('raw',bits,{name:'AES-GCM'},false,['encrypt','decrypt']);}
async function generateRoomKey(){return crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt']);}
async function exportRaw(key){return await crypto.subtle.exportKey('raw',key);}
async function importRawAES(ab){return crypto.subtle.importKey('raw',ab,{name:'AES-GCM'},false,['encrypt','decrypt']);}
async function aesEncrypt(key,text){const iv=crypto.getRandomValues(new Uint8Array(12));const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,new TextEncoder().encode(text));return {iv:abToB64(iv.buffer),ct:abToB64(ct)};}
async function aesDecrypt(key,ivB64,ctB64){const iv=new Uint8Array(b64ToAb(ivB64));const ct=b64ToAb(ctB64);const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,ct);return new TextDecoder().decode(pt);}

/* Auth */
auth.signInAnonymously().then(async r=>{me=r.user;ecdhKeyPair=await generateECDH();});

/* Nick claim/release */
function normNick(n){return n.trim().toLowerCase();}
claimNickBtn.addEventListener('click',async()=>{
  const n=nickInput.value.trim();
  if(!n||/\s/.test(n)){nickStatus.textContent='Ник обязателен, без пробелов.';nickStatus.className='small err';return;}
  const id=normNick(n);
  try{
    const ref=db.collection('nicknames').doc(id);
    const snap=await ref.get();
    if(snap.exists){nickStatus.textContent='Ник занят — выберите другой.';nickStatus.className='small err';return;}
    await ref.set({uid:me.uid,display:n,ts:firebase.firestore.FieldValue.serverTimestamp()});
    myNick=n;myNickId=id;
    claimNickBtn.style.display='none';releaseNickBtn.style.display='inline-block';
    nickStatus.textContent='Ник зарегистрирован ✔';nickStatus.className='small ok';
  }catch(err){console.error(err);nickStatus.textContent='Ошибка регистрации ника.';nickStatus.className='small err';}
});
releaseNickBtn.addEventListener('click',async()=>{if(myNickId){await db.collection('nicknames').doc(myNickId).delete().catch(()=>{});}myNick=myNickId=null;releaseNickBtn.style.display='none';claimNickBtn.style.display='inline-block';nickStatus.textContent='Ник освобождён.';nickStatus.className='small';});

/* Create session */
createSessionBtn.addEventListener('click',async()=>{
  if(!myNick){nickStatus.textContent='Сначала займитесь ником';nickStatus.className='small err';return;}
  isOwner=true;currentSession=Math.random().toString(36).slice(2,12);sessionIdEl.textContent=currentSession;
  const ownerPub=await exportPublic(ecdhKeyPair.publicKey);ownerPublicB64=ownerPub;roomKey=await generateRoomKey();
  await db.collection('sessions').doc(currentSession).set({ownerUid:me.uid,ownerNick:myNick,ownerPublicKey:ownerPub});
  await db.collection('sessions').doc(currentSession).collection('participants').doc(me.uid).set({uid:me.uid,nickname:myNick,publicKey:ownerPub});
  ownerInfo.textContent='Владелец: '+myNick;fpDiv.style.display='block';showFingerprint(ownerPub);
  copySessionBtn.style.display='inline-block';enableChatUI();listenParticipantsAsOwner();listenMessages();
});

/* Join session */
joinBtn.addEventListener('click',async()=>{
  if(!myNick){nickStatus.textContent='Сначала займитесь ником';nickStatus.className='small err';return;}
  const sid=joinInput.value.trim();if(!sid)return alert('Введите ID');
  const doc=await db.collection('sessions').doc(sid).get();if(!doc.exists)return alert('Нет сессии');
  currentSession=sid;sessionIdEl.textContent=sid;ownerPublicB64=doc.data().ownerPublicKey;ownerInfo.textContent='Владелец: '+(doc.data().ownerNick||doc.data().ownerUid);fpDiv.style.display='block';showFingerprint(ownerPublicB64);
  const myPub=await exportPublic(ecdhKeyPair.publicKey);participantDocRef=db.collection('sessions').doc(sid).collection('participants').doc(me.uid);await participantDocRef.set({uid:me.uid,nickname:myNick,publicKey:myPub});
  participantDocRef.onSnapshot(async snap=>{const d=snap.data();if(d&&d.encryptedRoomKey&&!roomKey){const [iv,ct]=d.encryptedRoomKey.split(':');const ownerPub=await importPublic(ownerPublicB64);const derived=await deriveSymKey(ecdhKeyPair.privateKey,ownerPub);const raw=await crypto.subtle.decrypt({name:'AES-GCM',iv:new Uint8Array(b64ToAb(iv))},derived,b64ToAb(ct));roomKey=await importRawAES(raw);enableChatUI();listenMessages();addSystem('Ключ получен.');}});
});

/* Owner: distribute roomKey */
function listenParticipantsAsOwner(){const col=db.collection('sessions').doc(currentSession).collection('participants');unsubParticipants=col.onSnapshot(async snap=>{participantsCount.textContent='Участников: '+snap.size;for(const ch of snap.docChanges()){if(ch.type==='added'){const d=ch.doc.data();if(d.publicKey&&!d.encryptedRoomKey){const pub=await importPublic(d.publicKey);const derived=await deriveSymKey(ecdhKeyPair.privateKey,pub);const raw=await exportRaw(roomKey);const iv=crypto.getRandomValues(new Uint8Array(12));const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},derived,raw);await ch.doc.ref.update({encryptedRoomKey:abToB64(iv.buffer)+':'+abToB64(ct)});}}}});}

/* Messages */
msgForm.addEventListener('submit',async e=>{e.preventDefault();const text=msgInput.value.trim();if(!text||!roomKey)return;const {iv,ct}=await aesEncrypt(roomKey,text);await db.collection('sessions').doc(currentSession).collection('messages').add({senderUid:me.uid,iv,ct,ts:firebase.firestore.FieldValue.serverTimestamp()});addMessage(text,true);msgInput.value='';});
function listenMessages(){if(unsubMessages)unsubMessages();unsubMessages=db.collection('sessions').doc(currentSession).collection('messages').orderBy('ts','asc').onSnapshot(async snap=>{for(const ch of snap.docChanges()){if(ch.type==='added'){const d=ch.doc.data();if(!roomKey)return;try{const pt=await aesDecrypt(roomKey,d.iv,d.ct);addMessage(pt,d.senderUid===me.uid);}catch(e){addSystem('Ошибка расшифровки');}}}});}
function enableChatUI(){msgInput.disabled=false;sendBtn.disabled=false;}
function addMessage(t,mine){const el=document.createElement('div');el.className='msg '+(mine?'mine':'their');el.textContent=t;messagesDiv.appendChild(el);messagesDiv.scrollTop=messagesDiv.scrollHeight;}
function addSystem(t){const el=document.createElement('div');el.className='msg sys';el.textContent=t;messagesDiv.appendChild(el);messagesDiv.scrollTop=messagesDiv.scrollHeight;}

/* Fingerprint */
async function showFingerprint(pub){const raw=b64ToAb(pub);const hash=await crypto.subtle.digest('SHA-256',raw);fpDiv.textContent='Fingerprint: '+Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');}

/* Panic */
panicBtn.addEventListener('click',async()=>{if(!currentSession)return;const msgs=db.collection('sessions').doc(currentSession).collection('messages');while(true){const snap=await msgs.limit(200).get();if(snap.empty)break;const batch=db.batch();snap.docs.forEach(d=>batch.delete(d.ref));await batch.commit();}if(participantDocRef)await participantDocRef.delete().catch(()=>{});if(myNickId)await db.collection('nicknames').doc(myNickId).delete().catch(()=>{});messagesDiv.innerHTML='';alert('Чат очищен');});

/* Leave */
leaveBtn.addEventListener('click',async()=>{if(participantDocRef)await participantDocRef.delete().catch(()=>{});if(myNickId)await db.collection('nicknames').doc(myNickId).delete().catch(()=>{});location.reload();});
</script>
</body>
</html>
